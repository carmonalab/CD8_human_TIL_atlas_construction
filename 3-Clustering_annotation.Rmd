---
title: "CD8 TIL Clustering + manual annotation"
author: "Paul Gueguen, Massimo Andreatta, and Santiago  Carmona"
date: "`r format(Sys.Date(),'%e de %B, %Y')`"
output: 
  rmdformats::downcute:
    lightbox: true
    thumbnails: false
    self_contained: true
    gallery: true
    code_folding: show
  pkgdown:
    as_is: true
---

```{r, include=FALSE, fig.width=16, fig.height=12}
library(renv)
renv::restore()
library(Seurat)
library(ggplot2)
library(scGate)
library(STACAS)
library(tidyverse)
library(SignatuR)
library(dplyr)
options(future.globals.maxSize= 5000*1024^2)
library(ProjecTILs)
```

# Setup parameters

```{r}
myPath <- "~/Dropbox/CSI/Datasets/Human_TIL_Atlas/CD8/"

path <- "./out/Utility.v0.4.CD8.integrated.stacas.semisup.rds"
integrated <- readRDS(path)

npcs = 30
umap.min.dist = 0.3
umap.neighbors = 30
metric = "cosine"

# Set up color palette
mycols <- c('NaiveLike' = '#b7d2e0', 'CM' = '#da6f6f','EM'= '#72b28a','TEMRA' = '#e5bfaf', 'TPEX' = '#aca6e0' , 'TEX' ='#f5d39f', "MAIT" = '#fdbfd4')
```

Rename cell types with CD8 prefix
```{r}
table(integrated$functional.cluster)

integrated$functional.cluster <- paste0("CD8.", integrated$functional.cluster)
names(mycols) <- paste0("CD8.", names(mycols))

#Reorder levels
integrated$functional.cluster <- factor(integrated$functional.cluster, levels=names(mycols))

```




Find markers for clusters - one cluster vs all the rest

```{r}
Idents(integrated) <- "functional.cluster"
DefaultAssay(integrated) <- "RNA"

sort(table(integrated$functional.cluster))
mean(table(integrated$functional.cluster,integrated$SampleLabel)>100)

set.seed(1234)

marker.list <- ProjecTILs::FindAllMarkers.bygroup(integrated, split.by = "SampleLabel",
                                 min.cells.group=30, min.pct=0.2,
                                 max.cells.per.ident = 1000, 
                                 features = NULL, test.use = "wilcox",
                                 min.diff.pct=0.1, min.freq = 0.8, verbose = F)


genes <- lapply(marker.list, function(x) {
  names(x) |> head(10)
})

marker.list

genes.use.bygroup <- unique(unlist(genes))
genes.use.bygroup
```



# Alternative approach to find marker genes, using a cluster tree and calculating DEG hierarchically

```{r}
library(ape)
Idents(integrated) <- "functional.cluster"
DefaultAssay(integrated) <- "RNA"

integrated <- BuildClusterTree(integrated, dims=1:npcs, assay="RNA") #features=integrated@assays$integrated@var.features
integrated.clusterTree <- Tool(object = integrated, slot = 'BuildClusterTree')
PlotClusterTree(integrated)
```

```{r}
node.marker <- FindAllMarkers(integrated, node=8, min.diff.pct = 0.3, min.cells.group=30, max.cells.per.ident = 1000, min.pct=0.1, logfc.threshold = 0.5)
node.marker$pos <- node.marker$avg_log2FC>0
node.marker.list <- split(node.marker, list(node.marker$pos,node.marker$cluster))
node.marker.list

node.genes <- lapply(node.marker.list, function(x) {
  x$gene |> head(5)
})

node.genes
node.genes.use <- unique(unlist(node.genes))
node.genes.use
```




```{r}
genes.use <- unique(c(node.genes.use,genes.use.bygroup))
genes.use
```


# Unsupervised heatmap

```{r fig.height=6, fig.width=7}
library(pheatmap)

integrated@misc$atlas.palette <- mycols

h <- ProjecTILs::celltype.heatmap(integrated, cluster.col = 'functional.cluster',  metadata=c("SampleLabel", "Tissue"),
                  assay = "RNA", genes = genes.use, min.cells=30,
                  ref=integrated, cluster_genes = T, cluster_samples = FALSE)
ggsave("plots/CD8T_heatmap_pseudobulk_unclustered.pdf", plot=h, height=7.5, width=5.5)

h <- ProjecTILs::celltype.heatmap(integrated, cluster.col = 'functional.cluster',  metadata=c("SampleLabel", "Tissue"),
                  assay = "RNA", genes = genes.use, min.cells=30,
                  ref=integrated, cluster_genes = TRUE, cluster_samples = TRUE, method="average")
ggsave("plots/CD8T_heatmap_pseudobulk_clustered.pdf", plot=h, height=8.5, width=7.5)


h <- ProjecTILs::celltype.heatmap(integrated, cluster.col = 'functional.cluster',  metadata=c("SampleLabel", "Tissue"),
                  assay = "RNA", genes = genes.use, min.cells=30,
                  ref=integrated, cluster_genes = TRUE, cluster_samples = TRUE, method="ward.D2")
ggsave("plots/CD8T_heatmap_pseudobulk_clustered.w2.pdf", plot=h, height=8.5, width=7.5)

```


# Building reference from ssSTACAS integrated object

```{r}
# Transform into reference + Recompute UMAP
DefaultAssay(integrated) <- "integrated"
ref <- ProjecTILs::make.reference(integrated, ndim = npcs,
                                  recalculate.umap = T, atlas.name = "Human CD8 TILs",
                                  umap.method = "umap", min_dist = umap.min.dist,
                                  metric = metric,
                                  n_neighbors = umap.neighbors)
p <- DimPlot(ref, label=T, cols = mycols) + theme(aspect.ratio = 1)
p
ggsave("plots/CD8T_human_ref_v0.2.png", height = 4, width=6)

# Adding scGate model to the object
models <- scGate::get_scGateDB(branch = 'dev', force_update = T)
gate.CD8.TIL <- models$human$generic$CD8TIL
ref@misc$scGate$human <- gate.CD8.TIL

# Add color scheme to the object
ref@misc$atlas.palette <- mycols

# Refactor levels
Idents(ref) <- factor(Idents(ref), levels = names(mycols))
ref$functional.cluster <- factor(ref$functional.cluster, levels = names(mycols))

```

```{r, eval=F}
# Saving
path <- "~/Dropbox/CSI/Datasets/projectTils/CD8T_human_ref_v0.2.rds"
saveRDS(ref, file = path)

#ref.cd8 <- readRDS(file = "~/Dropbox/CSI/Datasets/projectTils/CD8T_human_ref_v0.2.rds")
```


```{r}
a <- DimPlot(ref, reduction = "umap",
        cols = mycols_scGate, group.by = "scGate_multi", raster = T) +
  ggtitle('scGate_multi') + theme(aspect.ratio = 1)

b <- DimPlot(ref, reduction = "umap",
        group.by = "SampleLabel", raster = T) +
  theme(aspect.ratio = 1, legend.text = element_text(size=7),
        legend.key.size = unit(0.1, 'cm'))

b | a

ggsave("plots/umap_ssIntegration_2nd.pdf", height=4, width=9)


```

```{r}
a <- DimPlot(ref, reduction = "umap",
        cols = mycols, group.by = "functional.cluster", raster = T) +
  ggtitle('Exp annotation') + theme(aspect.ratio = 1)

b <- DimPlot(ref, reduction = "umap",
        group.by = "SampleLabel", raster = T) +
  theme(aspect.ratio = 1, legend.text = element_text(size=7),
        legend.key.size = unit(0.1, 'cm'))

b | a

ggsave("plots/umap_ssIntegration_2nd_wlabels.pdf", height=4, width=9)

```

# Violin annotation

```{r fig.height=4, fig.width=2.5}
DefaultAssay(ref) <- "RNA"

genes <- c('SELL','LEF1',"S1PR1", "TCF7", "CCR7","LMNA","IL7R","GZMA","GZMK",'CCL4',
           "FGFBP2",'FCGR3A',"GNLY",'XCL1',"XCL2","CRTAM","GNG4","TOX",'PDCD1',
           "GZMB","PRF1","LAG3","HAVCR2",'KLRB1','TRAV1-2')

VlnPlot(ref, features = genes, stack = TRUE, flip = TRUE, fill.by = "ident", cols = mycols)

ggsave("plots/CD8_ref_subset_violins.pdf", height=12, width=6)

#Horizontal version

v <- VlnPlot(ref, features = genes, stack = TRUE, flip = FALSE, fill.by = "ident", cols = mycols)

ggsave("plots/CD8_ref_subset_violins_horizontal.pdf", plot=v, height=4, width=12)

DefaultAssay(ref) <- "integrated"

```


# Downsample reference

```{r eval=T}
set.seed(123)
ref.cd8.downsample <- subset(ref,  downsample = 2000)
Idents(ref.cd8.downsample) <- "functional.cluster"
DefaultAssay(ref.cd8.downsample) <- "integrated"
ref.cd8.downsample <- ProjecTILs::make.reference(ref.cd8.downsample, ndim = npcs,
                                  recalculate.umap = T, atlas.name = "Human CD8 TILs",
                                  umap.method = "umap", min_dist = umap.min.dist,
                                  metric = metric,
                                  n_neighbors = umap.neighbors)

ref.cd8.downsample$functional.cluster <- factor(ref.cd8.downsample$functional.cluster, levels = names(mycols))

#scGate models
models <- scGate::get_scGateDB(branch = 'dev')
gate.CD8.TIL <- models$human$generic$CD8TIL
ref.cd8.downsample@misc$scGate$human <- gate.CD8.TIL

gate.CD8.mouse <- models$mouse$generic$CD8T
ref.cd8.downsample@misc$scGate$mouse <- gate.CD8.mouse


# Add color scheme to the object
ref.cd8.downsample@misc$atlas.palette <- mycols

p <- DimPlot(ref.cd8.downsample, label=T, cols = mycols) + theme(aspect.ratio = 1)
p

```

```{r, eval=F}

# Saving
#path.ds <- "~/Dropbox/CSI/Datasets/projectTils/CD8T_human_ref_v0.2_ds.rds"
path.ds <- "~/Dropbox/CSI/reference_atlases/CD8T_human_ref_v1.rds"

saveRDS(ref.cd8.downsample, file = path.ds)



```

```{r}
a <- DimPlot(ref.cd8.downsample, reduction = "umap",
        cols = mycols_scGate, group.by = "scGate_multi", raster = T) +
  ggtitle('scGate_multi') + theme(aspect.ratio = 1)

b <- DimPlot(ref.cd8.downsample, reduction = "umap",
        group.by = "SampleLabel", raster = T) +
  theme(aspect.ratio = 1, legend.text = element_text(size=7),
        legend.key.size = unit(0.1, 'cm'))

b | a

ggsave("plots/umap_ssIntegration_downsample.pdf", height=4, width=9)


```

```{r}
a <- DimPlot(ref.cd8.downsample, reduction = "umap",
        cols = mycols, group.by = "functional.cluster", raster = T) +
  ggtitle('Exp annotation') + theme(aspect.ratio = 1)

b <- DimPlot(ref.cd8.downsample, reduction = "umap",
        group.by = "SampleLabel", raster = T) +
  theme(aspect.ratio = 1, legend.text = element_text(size=7),
        legend.key.size = unit(0.1, 'cm'))

b | a

ggsave("plots/umap_ssIntegration_downsample_wlabels.pdf", height=4, width=9)

```

 
# Violin annotation

```{r}
DefaultAssay(ref.cd8.downsample) <- "RNA"
Idents(ref.cd8.downsample) <- "functional.cluster"
genes <- c('SELL','LEF1',"S1PR1","IL7R", "TCF7", "CCR7","LMNA","ANXA1","HOPX","GZMA","GZMK","CCL4",
           "FGFBP2",'FCGR3A',"GNLY","KLRG1",'XCL1',"XCL2","CXCL13","CRTAM","TOX",'PDCD1',"HAVCR2","LAG3","CTLA4","ITGAE","CXCR6",
           "GZMB","PRF1",'KLRB1','TRAV1-2')

VlnPlot(ref.cd8.downsample, features = genes, stack = TRUE, flip = TRUE, fill.by = "ident", cols = mycols)
DefaultAssay(ref.cd8.downsample) <- "integrated"

ggsave("plots/CD8_ref_subset_violins_ds.pdf", height=12, width=6)
```

Subset composition by study / sample
(this should be done on whole set without downsampling)

```{r}
tab <- table(ref$SampleLabel, ref$functional.cluster)
tab.norm <- tab/rowSums(tab)

df <- reshape2::melt(tab.norm)
colnames(df) <- c("Study","Subtype","Frequency")

palette <- ref@misc$atlas.palette

ggplot(df, aes(x = Study, y = Frequency, 
            fill = Subtype)) + geom_bar(stat = "identity") + 
            theme_bw() + scale_fill_manual(values = mycols) +
            theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

ggsave("plots/CD8T_subset_composition.pdf", width=7, height=4)
```